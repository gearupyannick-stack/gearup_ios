# .github/workflows/ios_build.yml
name: iOS build

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter deps
        run: flutter pub get

      # Optionnel mais propre sur CI
      - name: Clean
        run: flutter clean

      - name: Build unsigned IPA (no codesign)
        run: flutter build ipa --release --no-codesign

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Runner-ipa
          path: build/ios/ipa/*.ipa

      # Optionnel: binaire simulateur iOS pour tests locaux (pas installable sur device)
      - name: Build iOS Simulator .app
        run: |
          flutter build ios --simulator --release
          cd build/ios/iphonesimulator
          zip -r Runner.app.zip Runner.app
      - name: Upload Simulator app
        uses: actions/upload-artifact@v4
        with:
          name: Runner-simulator
          path: build/ios/iphonesimulator/Runner.app.zip

      # Optional: upload to App Store with API key (set secrets first)
      - name: Install Fastlane
        run: brew install fastlane
      - name: Upload to App Store Connect (API key)
        if: ${{ success() && vars.ASC_UPLOAD == '1' }}
        env:
          APP_BUNDLE_ID: ${{ secrets.APP_BUNDLE_ID }}
          APP_STORE_CONNECT_APP_ID: ${{ secrets.APP_STORE_CONNECT_APP_ID }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_BASE64: ${{ secrets.ASC_KEY_BASE64 }}
        run: |
          cd ios
          echo "$ASC_KEY_BASE64" | base64 --decode > AuthKey_${ASC_KEY_ID}.p8
          fastlane deliver \
            --api_key_path AuthKey_${ASC_KEY_ID}.p8 \
            --api_key_id "$ASC_KEY_ID" \
            --api_key_issuer_id "$ASC_ISSUER_ID" \
            --app_identifier "$APP_BUNDLE_ID" \
            --ipa "../build/ios/ipa/Runner.ipa" \
            --skip_screenshots --skip_metadata --force \
            --submit_for_review false
