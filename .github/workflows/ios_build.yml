name: iOS Signed Build & Upload

on:
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: macos-14
    env:
      APP_BUNDLE_ID: com.gearup.app
      TEAM_ID: ${{ secrets.TEAM_ID }}
      IOS_CERT_P12_PASSWORD: ${{ secrets.IOS_CERT_P12_PASSWORD }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure LFS fetch
        run: |
          git lfs install
          git lfs pull

      - name: Sanity checks
        run: |
          set -e
          sw_vers
          xcodebuild -version
          test -f ios/Runner.xcodeproj/project.pbxproj
          if head -n1 ios/Runner.xcodeproj/project.pbxproj | grep -q 'version https://git-lfs.github.com/spec'; then
            echo "ERROR: pbxproj is a Git LFS pointer. Commit the real file."
            exit 1
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: flutter pub get
        run: flutter pub get

      - name: Locate p12 from repo (safe)
        id: p12
        run: |
          set -e
          CANDIDATES="dist.p12 ios/dist.p12 ios/gearup/dist.p12"
          FOUND=""
          for p in $CANDIDATES; do
            if [ -s "$p" ]; then FOUND="$p"; break; fi
          done
          if [ -z "$FOUND" ]; then
            echo "ERROR: No dist.p12 found in repo." >&2
            exit 1
          fi
          echo "Using $FOUND"
          # Copy only if different path to avoid macOS cp error "identical (not copied)"
          if [ "$FOUND" != "dist.p12" ]; then
            cp -f "$FOUND" dist.p12
          else
            echo "dist.p12 already in place"
          fi
          # Verify password matches the p12
          if ! openssl pkcs12 -in dist.p12 -noout -info -passin env:IOS_CERT_P12_PASSWORD >/dev/null 2>&1; then
            echo "ERROR: P12 password invalid for repo p12." >&2
            exit 1
          fi
          ls -lh dist.p12

      - name: Create signing keychain
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security list-keychains -d user -s build.keychain login.keychain

      - name: Import p12
        run: |
          security import dist.p12 -k build.keychain -P "$IOS_CERT_P12_PASSWORD" -A
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security find-identity -v -p codesigning build.keychain

      - name: Provisioning profile from repo
        run: |
          set -e
          CAND="*.mobileprovision ios/*.mobileprovision ios/gearup/*.mobileprovision"
          PROFILE=""
          for p in $CAND; do
            if ls $p >/dev/null 2>&1; then PROFILE=$(ls $p | head -n1); break; fi
          done
          if [ -z "$PROFILE" ]; then
            echo "ERROR: No .mobileprovision found in repo." >&2
            exit 1
          fi
          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"
          PLIST=$(/usr/bin/security cms -D -i "$PROFILE")
          NAME=$(echo "$PLIST" | /usr/bin/plutil -extract Name raw -)
          UUID=$(echo "$PLIST" | /usr/bin/plutil -extract UUID raw -)
          cp -f "$PROFILE" "$PROFILE_DIR/$UUID.mobileprovision"
          cat > ExportOptions.plist <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key><dict>
              <key>${APP_BUNDLE_ID}</key><string>${NAME}</string>
            </dict>
            <key>teamID</key><string>${TEAM_ID}</string>
          </dict></plist>
          PLIST
          /usr/bin/plutil -p ExportOptions.plist

      - name: Build IPA
        run: |
          flutter build ipa --release --export-options-plist ExportOptions.plist

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Signed-IPA
          path: build/ios/ipa/*.ipa
          if-no-files-found: error
