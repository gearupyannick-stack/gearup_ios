name: build-and-upload-ios
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ios:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter pub get
        run: flutter pub get

      - name: Show macOS & Xcode
        run: |
          sw_vers
          xcodebuild -version

      - name: CocoaPods install
        working-directory: ios
        run: pod install --repo-update

      - name: Sanity checks for secrets/files
        env:
          CERT_P12_PASSWORD: ${{ secrets.CERT_P12_PASSWORD }}
        run: |
          echo "P12 md5: $(md5 -q "$HOME/certs/dist.p12")"
          echo "Prov md5: $(md5 -q "$HOME/certs/profile.mobileprovision")"
          echo "P12 openssl check (should exit 0)…"
          set +e; openssl pkcs12 -in "$HOME/certs/dist.p12" -noout -info -passin pass:"$CERT_P12_PASSWORD" >/dev/null; echo "status=$?"; set -e

      - name: Write signing files from secrets
        env:
          CERT_P12_BASE64: ${{ secrets.CERT_P12_BASE64 }}
          CERT_P12_PASSWORD: ${{ secrets.CERT_P12_PASSWORD }}
          PROV_PROFILE_BASE64: ${{ secrets.PROV_PROFILE_BASE64 }}
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          mkdir -p "$HOME/certs"
          echo "$CERT_P12_BASE64"        | base64 --decode > "$HOME/certs/dist.p12"
          echo "$PROV_PROFILE_BASE64"    | base64 --decode > "$HOME/certs/profile.mobileprovision"
          echo "$APP_STORE_CONNECT_API_KEY_P8" | base64 --decode > "$HOME/certs/AuthKey.p8"

          echo "Validating P12 password quickly…"
          set +e
          openssl pkcs12 -in "$HOME/certs/dist.p12" -noout -info -passin pass:"$CERT_P12_PASSWORD" >/dev/null
          echo "status=$?"
          set -e

      - name: Extract cert & key from P12 (PEM + RSA fallback)
        env:
          CERT_P12_PASSWORD: ${{ secrets.CERT_P12_PASSWORD }}
        run: |
          mkdir -p "$HOME/certs/extracted"
          # Extract leaf cert and private key (unencrypted PEMs)
          openssl pkcs12 -in "$HOME/certs/dist.p12" \
            -passin pass:"$CERT_P12_PASSWORD" \
            -nodes -clcerts \
            -out "$HOME/certs/extracted/combined.pem"

          # Split cert and key
          awk 'BEGIN{c=0} /BEGIN CERTIFICATE/{c++} {print > sprintf("%s/cert_%d.pem", ENVIRON["HOME"]"/certs/extracted", c)}' "$HOME/certs/extracted/combined.pem"
          awk 'BEGIN{k=0} /BEGIN PRIVATE KEY/{k++} {print > sprintf("%s/key_%d.pem", ENVIRON["HOME"]"/certs/extracted", k)}' "$HOME/certs/extracted/combined.pem"

          # Normalize key formats: PKCS#8 (generic) and RSA (fallback)
          cp "$HOME/certs/extracted/key_0.pem" "$HOME/certs/extracted/signing_key_pkcs8.pem" || true
          openssl rsa -in "$HOME/certs/extracted/key_0.pem" -out "$HOME/certs/extracted/signing_key_rsa.pem" 2>/dev/null || true
          # Choose the leaf cert (usually cert_1.pem). If only one exists, use cert_0.pem.
          if [[ -f "$HOME/certs/extracted/cert_1.pem" ]]; then
            cp "$HOME/certs/extracted/cert_1.pem" "$HOME/certs/extracted/signing_cert.pem"
          else
            cp "$HOME/certs/extracted/cert_0.pem" "$HOME/certs/extracted/signing_cert.pem"
          fi

          echo "Extracted:"
          ls -lah "$HOME/certs/extracted"

      - name: Import cert & key to keychain (PEM, with RSA fallback)
        run: |
          KEYCHAIN="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain

          # Import certificate
          security import "$HOME/certs/extracted/signing_cert.pem" \
            -k build.keychain -A -t cert -f pem

          # Try PKCS#8 key first
          if security import "$HOME/certs/extracted/signing_key_pkcs8.pem" \
               -k build.keychain -A -t priv -f pkcs8 \
               -T /usr/bin/codesign -T /usr/bin/security; then
            echo "PKCS#8 key imported."
          else
            echo "PKCS#8 import failed, trying RSA…"
            security import "$HOME/certs/extracted/signing_key_rsa.pem" \
              -k build.keychain -A -t priv -f openssl \
              -T /usr/bin/codesign -T /usr/bin/security
          fi

          # Allow Xcode/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          security list-keychain -d user -s build.keychain login.keychain-db

          echo "Identities in keychain:"
          security find-identity -v -p codesigning build.keychain || true

      - name: Install provisioning profile (and export UUID & Name)
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i $HOME/certs/profile.mobileprovision)")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' /dev/stdin <<< "$(security cms -D -i $HOME/certs/profile.mobileprovision)")
          cp "$HOME/certs/profile.mobileprovision" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"
          echo "Installed provisioning profile:"
          echo "  UUID: $PROFILE_UUID"
          echo "  Name: $PROFILE_NAME"
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV

      - name: Build iOS archive (manual signing with profile UUID)
        env:
          TEAM_ID:         ${{ secrets.TEAM_ID }}
          APP_BUNDLE_ID:   ${{ secrets.APP_BUNDLE_ID }}
        run: |
          rm -rf build/ios
          cd ios
          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath "$GITHUB_WORKSPACE/build/ios/Runner.xcarchive" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$APP_BUNDLE_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
            PROVISIONING_PROFILE="$PROFILE_UUID" \
            archive | xcpretty && exit ${PIPESTATUS[0]}

      - name: Create export options (App Store)
        env:
          TEAM_ID:       ${{ secrets.TEAM_ID }}
          APP_BUNDLE_ID: ${{ secrets.APP_BUNDLE_ID }}
        run: |
          # Use the profile NAME for export mapping (exportOptions expects names, not UUIDs)
          cat > exportOptions.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>${TEAM_ID}</string>
            <key>compileBitcode</key><false/>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${APP_BUNDLE_ID}</key><string>${PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          PLIST
          echo "exportOptions.plist:"
          cat exportOptions.plist

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath "$GITHUB_WORKSPACE/build/ios/Runner.xcarchive" \
            -exportPath  "$GITHUB_WORKSPACE/build/ios/export" \
            -exportOptionsPlist exportOptions.plist \
            | xcpretty && exit ${PIPESTATUS[0]}
          ls -lah "$GITHUB_WORKSPACE/build/ios/export"

      # Optional: upload to TestFlight with the API key (you already have these)
      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID:     ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID:  ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_P8:     ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          xcrun altool --upload-app \
            -f "$GITHUB_WORKSPACE/build/ios/export/Runner.ipa" \
            --type ios \
            --apiKey "${APP_STORE_CONNECT_API_KEY_ID}" \
            --apiIssuer "${APP_STORE_CONNECT_API_ISSUER_ID}" \
            --apiKeyFile "$HOME/certs/AuthKey.p8"