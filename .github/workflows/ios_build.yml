name: Flutter Run iOS (no signing)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      upload_to_testflight:
        description: "Upload the signed IPA to TestFlight"
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]

jobs:
  build-ios:
    runs-on: macos-14
    env:
      KEYCHAIN_NAME: build.keychain-db
      KEYCHAIN_PASSWORD: temp_pass_123
      APP_BUNDLE_ID: ${{ secrets.APP_BUNDLE_ID }}
      TEAM_ID: ${{ secrets.TEAM_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter version
        run: flutter --version

      - name: Install dependencies
        run: flutter pub get

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install CocoaPods
        run: gem install cocoapods --no-document

      - name: Pod install
        working-directory: ios
        run: |
          pod repo update
          pod install

      - name: Build iOS (unsigned)
        run: flutter build ipa --release --no-codesign

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-unsigned
          path: build/ios/ipa/*.ipa

      - name: Create keychain
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          # Add to search list (keep existing)
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | sed 's/"//g')

      - name: Install signing certificate (.p12)
        env:
          CERT_P12_BASE64: ${{ secrets.CERT_P12_BASE64 }}
          CERT_P12_PASSWORD: ${{ secrets.CERT_P12_PASSWORD }}
        run: |
          echo "$CERT_P12_BASE64" | base64 --decode > cert.p12
          security import cert.p12 -k "$KEYCHAIN_NAME" -P "$CERT_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          # Allow codesign to use the key non-interactively
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security find-identity -v -p codesigning "$KEYCHAIN_NAME" || true